@page "/"
@model Web.Pages.PublicModel
@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
}

<div>
    <h2>Public Timeline</h2>

    @* ------------------- CHEEP INPUT BOX ------------------- *@
    @if (User.Identity?.IsAuthenticated ?? false)
    {
        <div class="cheepbox">
            <h3>What's on your mind, @User.Identity!.Name?</h3>

            <form method="post" enctype="multipart/form-data">
                <textarea asp-for="Text"
                          rows="4"
                          placeholder="Write your cheep (max 160 characters) — or just share a GIF!"
                          style="width: 100%; max-width: 680px; font-family: inherit; resize: vertical;"></textarea>
                <span asp-validation-for="Text" class="text-danger"></span>

                <div style="margin: 12px 0;">
                    <label for="Upload" style="display: block; margin-bottom: 6px; font-weight: 500;">
                        Attach image or GIF <em>(optional)</em>
                    </label>
                    <input type="file" asp-for="Upload" accept="image/jpeg,image/jpg,image/png,image/gif" />
                    <span asp-validation-for="Upload" class="text-danger"></span>
                </div>

                <input type="submit" value="Share" class="btn btn-primary" style="float: right;" />
            </form>

            @* Global error if neither text nor image is provided *@
            @if (!ModelState.IsValid && ModelState.ContainsKey(string.Empty))
            {
                <div class="text-danger mt-2">
                    @foreach (var error in ModelState[string.Empty].Errors)
                    {
                        <div>@error.ErrorMessage</div>
                    }
                </div>
            }
        </div>
    }

    @* ------------------- LIST OF CHEEPS ------------------- *@
    @if (Model.Cheeps.Any())
    {
        <ul id="messagelist" class="cheeps">
            @foreach (var cheep in Model.Cheeps)
            {
                <li>
                    <div class="cheep-content">
                        <p>
                            <strong>
                                <a href="/@cheep.AuthorName">@cheep.AuthorName</a>

                                @if (User.Identity?.IsAuthenticated == true &&
                                     User.Identity.Name is not null &&
                                     User.Identity.Name != cheep.AuthorName)
                                {
                                    var isFollowing = await Model.IsFollowingAsync(cheep.AuthorName);
                                    if (isFollowing)
                                    {
                                        <a href="?handler=Unfollow&followee=@cheep.AuthorName"
                                           class="text-danger"
                                           style="margin-left: 8px; font-size: 0.9em;">unfollow</a>
                                    }
                                    else
                                    {
                                        <a href="?handler=Follow&followee=@cheep.AuthorName"
                                           style="margin-left: 8px; font-size: 0.9em;">follow</a>
                                    }
                                }
                            </strong>

                            @if (!string.IsNullOrWhiteSpace(cheep.Text))
                            {
                                <br />
                                <span class="cheep-text">@cheep.Text</span>
                            }

                            <small class="text-muted">— @cheep.TimeStamp</small>
                        </p>

                        @if (!string.IsNullOrEmpty(cheep.ImageUrl))
                        {
                            <div class="cheep-image">
                                <img src="@cheep.ImageUrl"
                                     alt="Cheep media"
                                     loading="lazy"
                                     style="max-width: 100%; height: auto; border-radius: 12px; margin-top: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" />
                            </div>
                        }
                    </div>
                </li>
            }
        </ul>
    }
    else
    {
        <em>There are no cheeps so far.</em>
    }
</div>

@section Scripts {
    <partial name="~/Areas/Identity/Pages/_ValidationScriptsPartial.cshtml" />
}