@page "/"
@model Web.Pages.PublicModel
@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
}

<h2>Public Timeline</h2>

@if (User.Identity?.IsAuthenticated ?? false)
{
    <div class="cheepbox">
        <form method="post" enctype="multipart/form-data">
            <textarea asp-for="Text"
                      rows="4"
                      placeholder="Write a cheep or share a GIF"></textarea>

            <input type="file"
                   asp-for="Upload"
                   accept="image/jpeg,image/png,image/gif" />

            <input type="submit" value="Share" class="btn btn-primary" />
        </form>
    </div>
}

<a id="cheeps"></a>

@if (Model.Cheeps.Any())
{
    <ul class="cheeps">
        @foreach (var cheep in Model.Cheeps)
        {
            <li>
                <strong>
                    <a href="/@cheep.AuthorName">@cheep.AuthorName</a>

                    @if (User.Identity?.IsAuthenticated == true &&
                         User.Identity.Name is not null &&
                         User.Identity.Name != cheep.AuthorName)
                    {
                        var isFollowing = await Model.IsFollowingAsync(cheep.AuthorName);
                        if (isFollowing)
                        {
                            <a asp-page-handler="Unfollow"
                               asp-route-followee="@cheep.AuthorName"
                               class="text-danger"
                               style="margin-left: 8px; font-size: 0.9em;">unfollow</a>
                        }
                        else
                        {
                            <a asp-page-handler="Follow"
                               asp-route-followee="@cheep.AuthorName"
                               style="margin-left: 8px; font-size: 0.9em;">follow</a>
                        }
                    }
                </strong>

                @if (!string.IsNullOrWhiteSpace(cheep.Text))
                {
                    <p>@cheep.Text</p>
                }

                @if (!string.IsNullOrEmpty(cheep.ImageUrl))
                {
                    <img src="@cheep.ImageUrl" style="max-width:100%" />
                }

                <small>@cheep.TimeStamp</small>
            </li>
        }
    </ul>
}
else
{
    <em>No cheeps yet.</em>
}

<!-- Pagination -->
<nav style="margin-top:2rem; text-align:center;">
    <ul style="list-style:none; padding:0; display:inline-flex; gap:10px;">
        <li>
            @if (Model.PageNumber > 1)
            {
                <a class="btn btn-outline-secondary"
                   href="/?p=@(Model.PageNumber - 1)#cheeps">
                    ← Previous
                </a>
            }
            else
            {
                <span class="btn btn-outline-secondary disabled">← Previous</span>
            }
        </li>

        <li>
            <span class="btn btn-secondary disabled">
                Page @Model.PageNumber
            </span>
        </li>

        <li>
            @if (Model.HasNextPage)
            {
                <a class="btn btn-outline-secondary"
                   href="/?p=@(Model.PageNumber + 1)#cheeps">
                    Next →
                </a>
            }
            else
            {
                <span class="btn btn-outline-secondary disabled">Next →</span>
            }
        </li>
    </ul>
</nav>
